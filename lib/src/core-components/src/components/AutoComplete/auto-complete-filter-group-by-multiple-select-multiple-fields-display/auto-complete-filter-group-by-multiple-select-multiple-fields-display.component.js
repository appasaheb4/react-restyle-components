"use strict";import{jsx as c,jsxs as i,Fragment as ee}from"react/jsx-runtime";import te,{useState as f,useEffect as j,useRef as se}from"react";import{Icon as I}from"../../Icon/Icon";import e from"../../../tc.module.css";import{cn as l}from"../../../utils";import{debounce as $e}from"@techabl/core-utils";export const AutoCompleteFilterGroupByMultipleSelectMultipleFieldsDisplay=({uniqueField:p="_id",groupByField:re,selectionConfig:le={},displayConfig:ne={},uiConfig:oe={},loader:ce=!1,placeholder:M="Search...",data:h,hasError:K=!1,disable:ae=!1,isUpperCase:de=!1,name:ie,groupByDetails:A,onFilter:E,onUpdate:T,onSelect:w,onBlur:V,className:pe,style:ue,filterDebounceDelay:B=300})=>{const{isSelectedStringArray:$=!1,maxSelection:ze,onSelectionChange:z}=le,{displayKeys:he,displaySeparator:me=" - ",fallbackKeys:fe=["name","code"],renderItem:b,renderGroupName:J}=ne,{showGroupHeaders:be=!0,collapsibleGroups:N=!1,showSelectAllButtons:xe=!0,showSelectedSection:ge=!0,selectedPlaceholder:_,emptyStateMessage:ye="No results found",emptyStateDescription:ve="Try adjusting your search terms"}=oe,C=re||A?.groupByName||"lab",D=A?.defaultGroupName||"Default",Ie=A?.totalItemName||"department",Y=t=>{if(b){const r=b(t);if(typeof r=="string")return r}return(he||h.displayKey||fe).map(r=>t[r]).filter(Boolean).join(me)||"Unnamed Item"},we=(t,s)=>J?J(t,s):t,[H,P]=f(""),[u,G]=f({}),[R,S]=f({}),[O,x]=f([]),[Q,Ne]=f(new Set),[y,U]=f(!1),[Ce,Ge]=f(0),v=te.useCallback(()=>Object.keys(R).reduce((t,s)=>{const r=(R[s]||[]).filter(n=>n.selected);return r.length>0&&(t[s]=r),t},{}),[R]),Se=t=>{j(()=>{function s(r){if(t.current&&!t.current.contains(r.target)&&y){const n=v();w&&w(n),U(!1),P("")}}return document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[t,y,v,w])},W=se(u);j(()=>{const t=W.current;if(JSON.stringify(t)!==JSON.stringify(u)){const s=Array.isArray(u)?u.flat(Number.POSITIVE_INFINITY):Object.values(u).flat(Number.POSITIVE_INFINITY);T&&T(s),W.current=u}},[u,T]);const X=se(null);Se(X);const Z=(t,s)=>{const r={};let n=0;return Object.keys(t).forEach(o=>{const d=(t[o]||[]).map(m=>{n++;const L=s&&s.length>0?s.some(k=>$?k===m[p]:k[p]===m[p]):!1;return{...m,selected:L}});r[o]=d}),Ge(n),r};j(()=>{let t={};if(h.list&&Array.isArray(h.list)){const r=h.list.reduce((n,o)=>{const a=o?.[C]||D;return n[a]||(n[a]=[]),n[a].push(o),n},{});t=Z(r,h.selected||[])}else typeof h.list=="object"&&h.list!==null&&(t=Z(h.list,h.selected||[]));S(t),G(t);const s=[];Object.keys(t).forEach(r=>{const n=(t[r]||[]).filter(o=>o.selected);s.push(...n)}),x(Array.isArray(h?.selected)&&!$?h.selected:s)},[h,h.selected,$,p,C,D]);const F=te.useMemo(()=>$e(t=>{E&&E(t)},B),[E,B]),Oe=t=>{const s=t.target.value;P(s),F(s)},ke=t=>{if((t.which?t.which:t.keyCode)===8){const r=t.currentTarget.value;F(r)}},je=t=>{const s=new Set(Q);s.has(t)?s.delete(t):s.add(t),Ne(s)},q=(t,s,r)=>{const n=s.map(o=>({...o,selected:r}));if(G(o=>({...o,[t]:n})),S(o=>({...o,[t]:n})),r){const o=[...O];s.forEach(a=>{o.findIndex(m=>m[p]===a[p])===-1&&o.push({...a,selected:!0})}),x(o)}else{const o=O.filter(a=>!s.some(d=>d[p]===a[p]));x(o)}},Ae=(t,s,r)=>{const n=u[t][r],o=u[t].map((a,d)=>d===r?{...a,selected:!s}:a);G(a=>({...a,[t]:o})),S(a=>({...a,[t]:o})),x(s?a=>a.filter(d=>d[p]!==n[p]):a=>[...a,{...n,selected:!0}])},Ee=t=>{x(s=>s.filter(r=>r[p]!==t[p])),Object.keys(u).forEach(s=>{const r=u[s].map(n=>n[p]===t[p]?{...n,selected:!1}:n);G(n=>({...n,[s]:r})),S(n=>({...n,[s]:r}))})},Te=()=>{const t=Object.keys(u).sort();return t.length===0?i("div",{className:l(e["p-4"],e["text-center"],e["text-gray-500"]),children:[c(I,{nameIcon:"FaSearch",propsIcon:{size:24,color:"#ccc"}}),c("p",{className:l(e["mt-2"],e["text-sm"]),children:ye}),c("p",{className:l(e["text-xs"]),children:ve})]}):t.map(s=>{const r=u[s]||[],n=Q.has(s),o=r.filter(d=>d.selected).length,a=r.filter(d=>!d.selected);return i("div",{className:l(e["border-b"],e["border-gray-200"],e["last:border-b-0"]),children:[be&&i("div",{className:l(e.flex,e["items-center"],e["justify-between"],e["p-3"],e["bg-gray-50"],e["border-b"],e["border-gray-200"],e["font-semibold"],e["text-sm"],e["text-gray-700"],N&&e["cursor-pointer"],e["hover:bg-gray-100"]),onClick:()=>N&&je(s),children:[i("div",{className:l(e.flex,e["items-center"],e["gap-2"]),children:[N&&c(I,{nameIcon:n?"FaChevronRight":"FaChevronDown",propsIcon:{size:12,color:"#666"}}),c("span",{className:l(e["font-bold"],e["text-blue-700"]),children:we(s,r.length)}),i("span",{className:l(e["text-xs"],e["bg-blue-100"],e["text-blue-800"],e["px-2"],e["py-1"],e["rounded-full"]),children:[o,"/",r.length]})]}),xe&&i("div",{className:l(e.flex,e["gap-1"]),children:[c("button",{type:"button",onClick:d=>{d.stopPropagation(),q(s,r,!0)},className:l(e["text-xs"],e["px-2"],e["py-1"],e["bg-green-500"],e["text-white"],e.rounded,e["hover:bg-green-600"],e["transition-colors"],o===r.length&&e["opacity-50"],o===r.length&&e["cursor-not-allowed"]),title:`Select all in ${s}`,disabled:o===r.length,children:"All"}),c("button",{type:"button",onClick:d=>{d.stopPropagation(),q(s,r,!1)},className:l(e["text-xs"],e["px-2"],e["py-1"],e["bg-gray-500"],e["text-white"],e.rounded,e["hover:bg-gray-600"],e["transition-colors"],o===0&&e["opacity-50"],o===0&&e["cursor-not-allowed"]),title:`Deselect all in ${s}`,disabled:o===0,children:"None"})]})]}),(!N||!n)&&i("div",{className:l(e["max-h-60"],e["overflow-y-auto"]),children:[a.map((d,m)=>c("div",{className:l(e.flex,e["items-center"],e["gap-3"],e["p-3"],e["hover:bg-blue-50"],e["border-l-4"],e["border-transparent"],e["transition-colors"]),children:i("label",{className:l(e.flex,e["items-center"],e["cursor-pointer"],e["w-full"]),children:[c("input",{id:`${s}-${m}`,className:l(e["h-4"],e["w-4"],e["text-blue-600"],e["border-gray-300"],e.rounded,e["focus:ring-blue-500"],e["cursor-pointer"]),type:"checkbox",checked:!1,onChange:()=>{const L=u[s].findIndex(k=>k[p]===d[p]);Ae(s,!1,L)}}),c("div",{className:l(e["ml-3"],e.flex,e["flex-col"]),children:b?b(d):c("span",{className:l(e["text-sm"],e["font-medium"],e["text-gray-700"]),children:Y(d)})})]})},`${s}-${d[p]||m}`)),a.length===0&&r.length>0&&c("div",{className:l(e["p-3"],e["text-center"],e["text-gray-500"],e["text-sm"]),children:"All items in this group are selected"})]})]},s)})},g=()=>O?.length;return j(()=>{z&&z(v())},[u,z,v]),c(ee,{children:i("div",{ref:X,className:l(e["w-full"],e.relative,pe),style:ue,children:[i("div",{className:l(e.flex,e["items-center"],e["leading-4"],e["p-2"],e["focus:outline-none"],e["focus:ring"],e["w-full"],e["shadow-sm"],e["sm:text-base"],e.border,e["rounded-md"],{[e["border-red"]]:K,[e["border-gray-300"]]:!K},e["bg-white"]),children:[c("input",{placeholder:M,disabled:ae,name:ie,value:y?de?H?.toUpperCase():H:g()>0?typeof _=="function"?_(g()):_||`${g()} Items Selected`:M,className:l(e["w-full"],e["focus:outline-none"],e["bg-transparent"]),onKeyUp:ke,onChange:Oe,onClick:()=>U(!0),onBlur:t=>V&&V(t)}),ce?c("div",{className:l(e["animate-spin"],e["w-4"],e["h-4"]),children:c(I,{nameIcon:"FaSpinner",propsIcon:{size:16,color:"#666"}})}):c(I,{nameIcon:y?"FaChevronUp":"FaChevronDown",propsIcon:{size:16,color:"#000000"}})]}),y&&i("div",{className:l(e["mt-1"],e.absolute,e["rounded-md"],e["bg-white"],e.border,e["border-gray-300"],e["shadow-lg"],e["z-50"],e["w-full"],e["max-h-96"],e["overflow-hidden"]),style:{zIndex:1e3},children:[c("div",{className:l(e["p-3"],e["border-b"],e["border-gray-200"],e["bg-gray-50"],e["text-sm"],e["font-medium"],e["text-gray-700"]),children:i("div",{className:l(e.flex,e["justify-between"],e["items-center"]),children:[i("span",{children:[Object.keys(u).length," ",C?.toUpperCase(),", ",Ce," ",Ie?.toUpperCase()]}),i("div",{className:"flex items-center gap-2",children:[i("span",{className:l(e["text-blue-600"]),children:[g()," Selected"]}),c("div",{className:l(e.flex,e["gap-2"]),children:c("button",{type:"button",className:l(e["text-xs"],e["px-3"],e["py-1"],e["bg-blue-600"],e["text-white"],e.rounded,e["hover:bg-blue-700"],e["transition-colors"]),onClick:()=>{const t=v();w(t),U(!1),P("")},children:"OK"})})]})]})}),i("div",{className:l(e["max-h-80"],e["overflow-y-auto"]),children:[ge&&g()>0&&i("div",{className:l(e["border-b"],e["border-gray-200"]),children:[c("div",{className:l(e["p-3"],e["bg-blue-50"],e["border-b"],e["border-blue-200"],e["font-semibold"],e["text-sm"],e["text-blue-700"]),children:i("div",{className:l(e.flex,e["items-center"],e["gap-2"]),children:[c(I,{nameIcon:"FaCheck",propsIcon:{size:12,color:"#1976d2"}}),i("span",{children:["Selected Items (",g(),")"]})]})}),c("div",{className:l(e["max-h-48"],e["overflow-y-auto"]),children:O?.map((t,s)=>c("div",{className:l(e.flex,e["items-center"],e["gap-3"],e["p-3"],e["hover:bg-blue-50"],e["border-l-4"],e["border-blue-500"],e["bg-blue-25"],e["transition-colors"]),children:i("label",{className:l(e.flex,e["items-center"],e["cursor-pointer"],e["w-full"]),children:[c("input",{type:"checkbox",checked:!0,onChange:()=>Ee(t),className:l(e["h-4"],e["w-4"],e["text-blue-600"],e["border-gray-300"],e.rounded,e["focus:ring-blue-500"],e["cursor-pointer"])}),c("div",{className:l(e["ml-3"],e.flex,e["flex-col"]),children:b?b(t):i(ee,{children:[c("span",{className:l(e["text-sm"],e["font-medium"],e["text-blue-700"]),children:Y(t)}),c("span",{className:l(e["text-xs"],e["text-gray-500"]),children:t[C]||D})]})})]})},`selected-${t[p]||s}`))})]}),c("div",{children:Te()})]})]})]})})};
