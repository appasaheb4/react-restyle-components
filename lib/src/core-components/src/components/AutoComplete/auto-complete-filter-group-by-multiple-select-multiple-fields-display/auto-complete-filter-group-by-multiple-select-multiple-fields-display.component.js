"use strict";import{jsx as c,jsxs as i,Fragment as me}from"react/jsx-runtime";import fe,{useState as f,useEffect as E,useRef as X,useCallback as L}from"react";import{Icon as v}from"../../Icon/Icon";import e from"../../../tc.module.css";import{cn as n}from"../../../utils";export const AutoCompleteFilterGroupByMultipleSelectMultipleFieldsDisplay=({uniqueField:p="_id",groupByField:be,selectionConfig:xe={},displayConfig:ge={},uiConfig:ye={},loader:ve=!1,placeholder:Z="Search...",data:d,hasError:q=!1,disable:Ie=!1,isUpperCase:we=!1,name:Ce,groupByDetails:z,onFilter:ee,onUpdate:I,onSelect:S,onBlur:te,className:Ne,style:Se,filterDebounceDelay:se=500,optionsRenderKey:Ge})=>{const{isSelectedStringArray:P=!1,maxSelection:qe,onSelectionChange:R}=xe,{displayKeys:_,displaySeparator:ke=" - ",fallbackKeys:D=["name","code"],renderItem:x,renderGroupName:re}=ge,{showGroupHeaders:Oe=!0,collapsibleGroups:G=!1,showSelectAllButtons:je=!0,showSelectedSection:Ae=!0,selectedPlaceholder:M,emptyStateMessage:Te="No results found",emptyStateDescription:Fe="Try adjusting your search terms",enableInternalFilter:ne=!1,showGroupSearch:$e=!1,groupSearchMinItems:Ee=5}=ye,k=be||z?.groupByName||"lab",K=z?.defaultGroupName||"Default",Le=z?.totalItemName||"department",le=t=>{if(x){const s=x(t);if(typeof s=="string")return s}return(_||d.displayKey||D).map(s=>t[s]).filter(Boolean).join(ke)||"Unnamed Item"},ze=(t,r)=>re?re(t,r):t,[oe,O]=f(""),[m,j]=f({}),[U,A]=f({}),[T,g]=f([]),[ce,Pe]=f(new Set),[w,V]=f(!1),[Re,_e]=f(0),[B,Y]=f(""),[F,ae]=f({}),H=L((t,r)=>{if(!r||r.trim()==="")return t;const s=r.toLowerCase().trim(),o=_||d.displayKey||D;return t.filter(l=>o.some(a=>{const u=l[a];return typeof u=="string"?u.toLowerCase().includes(s):typeof u=="number"?u.toString().includes(s):!1}))},[_,d.displayKey,D]),De=L(()=>{const t={},r=B.trim();return Object.keys(m).forEach(s=>{const o=m[s]||[];let l=r?H(o,r):o;const a=F[s]?.trim();a&&(l=H(l,a)),l.length>0&&(t[s]=l)}),t},[m,B,F,H]),Me=(t,r)=>{ae(s=>({...s,[t]:r}))},Ke=t=>{ae(r=>{const s={...r};return delete s[t],s})},C=fe.useCallback(()=>Object.keys(U).reduce((t,r)=>{const s=(U[r]||[]).filter(o=>o.selected);return s.length>0&&(t[r]=s),t},{}),[U]),Ue=t=>{E(()=>{function r(s){if(t.current&&!t.current.contains(s.target)&&w){const o=C();S&&S(o);const l=J(m);I&&I(l),V(!1),O("")}}return document.addEventListener("mousedown",r),()=>{document.removeEventListener("mousedown",r)}},[t,w,C,S,m,J,I])},J=L(t=>Array.isArray(t)?t.flat(Number.POSITIVE_INFINITY):Object.values(t).flat(Number.POSITIVE_INFINITY),[]),ie=X(null);Ue(ie);const de=(t,r)=>{const s={};let o=0;return Object.keys(t).forEach(l=>{const u=(t[l]||[]).map(b=>{o++;const W=r&&r.length>0?r.some($=>P?$===b[p]:$[p]===b[p]):!1;return{...b,selected:W}});s[l]=u}),_e(o),s},Ve=fe.useMemo(()=>d.list?Array.isArray(d.list)?d.list.length.toString():Object.keys(d.list).map(r=>`${r}:${d.list[r]?.length||0}`).join(","):"",[d.list]);E(()=>{let t={};if(d.list&&Array.isArray(d.list)){const s=d.list.reduce((o,l)=>{const a=l?.[k]||K;return o[a]||(o[a]=[]),o[a].push(l),o},{});t=de(s,d.selected||[])}else typeof d.list=="object"&&d.list!==null&&(t=de(d.list,d.selected||[]));A(t),j(t);const r=[];Object.keys(t).forEach(s=>{const o=(t[s]||[]).filter(l=>l.selected);r.push(...o)}),g(Array.isArray(d?.selected)&&!P?d.selected:r)},[d.list,d.selected,P,p,k,K,Ve]);const Q=X(ee);Q.current=ee;const N=X(null);E(()=>()=>{N.current&&clearTimeout(N.current)},[]);const ue=L(t=>{Q.current&&(N.current&&clearTimeout(N.current),N.current=setTimeout(()=>{Q.current?.(t)},se))},[se]),Be=t=>{const r=t.target.value;O(r),ne&&Y(r),ue(r)},Ye=t=>{if((t.which?t.which:t.keyCode)===8){const s=t.currentTarget.value;ne&&Y(s),ue(s)}},He=t=>{const r=new Set(ce);r.has(t)?r.delete(t):r.add(t),Pe(r)},pe=(t,r,s)=>{const o=r.map(l=>({...l,selected:s}));if(j(l=>({...l,[t]:o})),A(l=>({...l,[t]:o})),s){const l=[...T];r.forEach(a=>{l.findIndex(b=>b[p]===a[p])===-1&&l.push({...a,selected:!0})}),g(l)}else{const l=T.filter(a=>!r.some(u=>u[p]===a[p]));g(l)}},Je=(t,r,s)=>{const o=m[t][s],l=m[t].map((a,u)=>u===s?{...a,selected:!r}:a);j(a=>({...a,[t]:l})),A(a=>({...a,[t]:l})),g(r?a=>a.filter(u=>u[p]!==o[p]):a=>[...a,{...o,selected:!0}])},Qe=t=>{g(r=>r.filter(s=>s[p]!==t[p])),Object.keys(m).forEach(r=>{const s=m[r].map(o=>o[p]===t[p]?{...o,selected:!1}:o);j(o=>({...o,[r]:s})),A(o=>({...o,[r]:s}))})},We=()=>{const t=De(),r=Object.keys(t).sort();return r.length===0?i("div",{className:n(e["p-4"],e["text-center"],e["text-gray-500"]),children:[c(v,{nameIcon:"FaSearch",propsIcon:{size:24,color:"#ccc"}}),c("p",{className:n(e["mt-2"],e["text-sm"]),children:Te}),c("p",{className:n(e["text-xs"]),children:Fe}),B&&c("button",{type:"button",onClick:()=>{Y(""),O("")},className:n(e["mt-3"],e["text-xs"],e["px-3"],e["py-1"],e["bg-blue-500"],e["text-white"],e.rounded,e["hover:bg-blue-600"]),children:"Clear Search"})]}):r.map(s=>{const o=t[s]||[],l=m[s]||[],a=ce.has(s),u=l.filter(h=>h.selected).length,b=o.filter(h=>!h.selected),W=!!F[s],$=$e&&l.length>=Ee;return i("div",{className:n(e["border-b"],e["border-gray-200"],e["last:border-b-0"]),children:[Oe&&i("div",{className:n(e.flex,e["flex-col"],e["bg-gradient-to-r"],e["from-blue-50"],e["to-indigo-50"],e["border-b"],e["border-blue-200"]),children:[i("div",{className:n(e.flex,e["items-center"],e["justify-between"],e["p-3"],e["font-semibold"],e["text-sm"],e["text-gray-700"],G&&e["cursor-pointer"],e["hover:bg-blue-100"],e["transition-colors"]),onClick:()=>G&&He(s),children:[i("div",{className:n(e.flex,e["items-center"],e["gap-2"]),children:[G&&c(v,{nameIcon:a?"FaChevronRight":"FaChevronDown",propsIcon:{size:12,color:"#4F46E5"}}),c("span",{className:n(e["font-bold"],e["text-indigo-700"],e["text-base"]),children:ze(s,l.length)}),i("span",{className:n(e["text-xs"],e["bg-indigo-100"],e["text-indigo-800"],e["px-2"],e["py-1"],e["rounded-full"],e["font-medium"]),children:[u,"/",l.length]}),o.length!==l.length&&i("span",{className:n(e["text-xs"],e["bg-amber-100"],e["text-amber-800"],e["px-2"],e["py-1"],e["rounded-full"]),children:[o.length," shown"]})]}),je&&i("div",{className:n(e.flex,e["gap-1"]),children:[c("button",{type:"button",onClick:h=>{h.stopPropagation(),pe(s,l,!0)},className:n(e["text-xs"],e["px-2"],e["py-1"],e["bg-emerald-500"],e["text-white"],e.rounded,e["hover:bg-emerald-600"],e["transition-colors"],e["shadow-sm"],u===l.length&&e["opacity-50"],u===l.length&&e["cursor-not-allowed"]),title:`Select all in ${s}`,disabled:u===l.length,children:"All"}),c("button",{type:"button",onClick:h=>{h.stopPropagation(),pe(s,l,!1)},className:n(e["text-xs"],e["px-2"],e["py-1"],e["bg-slate-500"],e["text-white"],e.rounded,e["hover:bg-slate-600"],e["transition-colors"],e["shadow-sm"],u===0&&e["opacity-50"],u===0&&e["cursor-not-allowed"]),title:`Deselect all in ${s}`,disabled:u===0,children:"None"})]})]}),$&&!a&&c("div",{className:n(e["px-3"],e["pb-2"]),children:i("div",{className:n(e.relative),children:[c("input",{type:"text",placeholder:`Search in ${s}...`,value:F[s]||"",onChange:h=>Me(s,h.target.value),onClick:h=>h.stopPropagation(),className:n(e["w-full"],e["px-3"],e["py-1.5"],e["text-sm"],e.border,e["border-indigo-200"],e["rounded-md"],e["focus:outline-none"],e["focus:ring-2"],e["focus:ring-indigo-300"],e["focus:border-indigo-400"],e["bg-white"],e["placeholder-gray-400"])}),W&&c("button",{type:"button",onClick:h=>{h.stopPropagation(),Ke(s)},className:n(e.absolute,e["right-2"],e["top-1/2"],e["-translate-y-1/2"],e["text-gray-400"],e["hover:text-gray-600"]),children:c(v,{nameIcon:"FaTimes",propsIcon:{size:12,color:"currentColor"}})})]})})]}),(!G||!a)&&i("div",{className:n(e["max-h-60"],e["overflow-y-auto"]),children:[b.map((h,he)=>c("div",{className:n(e.flex,e["items-center"],e["gap-3"],e["p-3"],e["hover:bg-blue-50"],e["border-l-4"],e["border-transparent"],e["transition-colors"]),children:i("label",{className:n(e.flex,e["items-center"],e["cursor-pointer"],e["w-full"]),children:[c("input",{id:`${s}-${he}`,className:n(e["h-4"],e["w-4"],e["text-blue-600"],e["border-gray-300"],e.rounded,e["focus:ring-blue-500"],e["cursor-pointer"]),type:"checkbox",checked:!1,onChange:()=>{const Xe=m[s].findIndex(Ze=>Ze[p]===h[p]);Je(s,!1,Xe)}}),c("div",{className:n(e["ml-3"],e.flex,e["flex-col"]),children:x?x(h):c("span",{className:n(e["text-sm"],e["font-medium"],e["text-gray-700"]),children:le(h)})})]})},`${s}-${h[p]||he}`)),b.length===0&&o.length>0&&c("div",{className:n(e["p-3"],e["text-center"],e["text-gray-500"],e["text-sm"]),children:"All items in this group are selected"})]})]},s)})},y=()=>T?.length;return E(()=>{R&&R(C())},[m,R,C]),c(me,{children:i("div",{ref:ie,className:n(e["w-full"],e.relative,Ne),style:Se,children:[i("div",{className:n(e.flex,e["items-center"],e["leading-4"],e["p-2"],e["focus:outline-none"],e["focus:ring"],e["w-full"],e["shadow-sm"],e["sm:text-base"],e.border,e["rounded-md"],{[e["border-red"]]:q,[e["border-gray-300"]]:!q},e["bg-white"]),children:[c("input",{placeholder:Z,disabled:Ie,name:Ce,value:w?we?oe?.toUpperCase():oe:y()>0?typeof M=="function"?M(y()):M||`${y()} Items Selected`:Z,className:n(e["w-full"],e["focus:outline-none"],e["bg-transparent"]),onKeyUp:Ye,onChange:Be,onClick:()=>V(!0),onBlur:t=>te&&te(t)}),ve?c("div",{className:n(e["animate-spin"],e["w-4"],e["h-4"]),children:c(v,{nameIcon:"FaSpinner",propsIcon:{size:16,color:"#666"}})}):c(v,{nameIcon:w?"FaChevronUp":"FaChevronDown",propsIcon:{size:16,color:"#000000"}})]}),w&&i("div",{className:n(e["mt-1"],e.absolute,e["rounded-md"],e["bg-white"],e.border,e["border-gray-300"],e["shadow-lg"],e["z-50"],e["w-full"],e["max-h-96"],e["overflow-hidden"]),style:{zIndex:1e3},children:[c("div",{className:n(e["p-3"],e["border-b"],e["border-gray-200"],e["bg-gray-50"],e["text-sm"],e["font-medium"],e["text-gray-700"]),children:i("div",{className:n(e.flex,e["justify-between"],e["items-center"]),children:[i("span",{children:[Object.keys(m).length," ",k?.toUpperCase(),", ",Re," ",Le?.toUpperCase()]}),i("div",{className:"flex items-center gap-2",children:[i("span",{className:n(e["text-blue-600"]),children:[y()," Selected"]}),c("div",{className:n(e.flex,e["gap-2"]),children:c("button",{type:"button",className:n(e["text-xs"],e["px-3"],e["py-1"],e["bg-blue-600"],e["text-white"],e.rounded,e["hover:bg-blue-700"],e["transition-colors"]),onClick:()=>{const t=C();S(t);const r=J(m);I&&I(r),V(!1),O("")},children:"OK"})})]})]})}),i("div",{className:n(e["max-h-80"],e["overflow-y-auto"]),children:[Ae&&y()>0&&i("div",{className:n(e["border-b"],e["border-gray-200"]),children:[c("div",{className:n(e["p-3"],e["bg-blue-50"],e["border-b"],e["border-blue-200"],e["font-semibold"],e["text-sm"],e["text-blue-700"]),children:i("div",{className:n(e.flex,e["items-center"],e["gap-2"]),children:[c(v,{nameIcon:"FaCheck",propsIcon:{size:12,color:"#1976d2"}}),i("span",{children:["Selected Items (",y(),")"]})]})}),c("div",{className:n(e["max-h-48"],e["overflow-y-auto"]),children:T?.map((t,r)=>c("div",{className:n(e.flex,e["items-center"],e["gap-3"],e["p-3"],e["hover:bg-blue-50"],e["border-l-4"],e["border-blue-500"],e["bg-blue-25"],e["transition-colors"]),children:i("label",{className:n(e.flex,e["items-center"],e["cursor-pointer"],e["w-full"]),children:[c("input",{type:"checkbox",checked:!0,onChange:()=>Qe(t),className:n(e["h-4"],e["w-4"],e["text-blue-600"],e["border-gray-300"],e.rounded,e["focus:ring-blue-500"],e["cursor-pointer"])}),c("div",{className:n(e["ml-3"],e.flex,e["flex-col"]),children:x?x(t):i(me,{children:[c("span",{className:n(e["text-sm"],e["font-medium"],e["text-blue-700"]),children:le(t)}),c("span",{className:n(e["text-xs"],e["text-gray-500"]),children:t[k]||K})]})})]})},`selected-${t[p]||r}`))})]}),c("div",{children:We()})]})]},Ge)]})})};
