"use strict";import{useState as g,useCallback as S,useMemo as D,useEffect as R}from"react";export function useTableDebounce(r,e){const[s,t]=g(r);return R(()=>{const a=setTimeout(()=>{t(r)},e);return()=>clearTimeout(a)},[r,e]),s}export function useSortState(r,e,s=!1){const[t,a]=g(r||{field:"",order:null}),i=e??t,o=S((n,l)=>{let c;i.field!==n||l===null?c="asc":l==="asc"?c="desc":c=null;const u={field:n,order:c};return a(u),u},[i.field]);return{sort:i,handleSort:o,setSort:a}}export function useFilterState(r,e){const[s,t]=g(r||{}),a=e??s,i=S((n,l)=>{t(c=>{if(l==null||l===""){const{[n]:u,...x}=c;return x}return{...c,[n]:l}})},[]),o=S(()=>{t({})},[]);return{filters:a,setFilter:i,clearFilters:o,setFilters:t}}export function usePaginationState(r=0,e=10,s=0){const[t,a]=g(r),[i,o]=g(e),n=Math.ceil(s/i)||1,l=S(w=>{const d=Math.max(0,Math.min(w,n-1));a(d)},[n]),c=S(()=>{l(t+1)},[t,l]),u=S(()=>{l(t-1)},[t,l]),x=S(()=>{l(0)},[l]),m=S(()=>{l(n-1)},[n,l]),f=S(w=>{o(w),a(0)},[]);return{page:t,pageSize:i,totalPages:n,goToPage:l,goToNextPage:c,goToPrevPage:u,goToFirstPage:x,goToLastPage:m,changePageSize:f,setPage:a,setPageSize:o}}export function useRowSelection(r,e="_id",s="none",t,a){const[i,o]=g(new Set),n=t?new Set(t):i,l=S(w=>n.has(w),[n]),c=S(w=>{const d=w[e];if(a?.(w)?.disabled)return;if(s==="single")return o(new Set([d])),{selectedKeys:[d],selectedRows:[w]};o(b=>{const E=new Set(b);return E.has(d)?E.delete(d):E.add(d),E});const h=n.has(d)?Array.from(n).filter(b=>b!==d):[...Array.from(n),d];return{selectedKeys:h,selectedRows:r.filter(b=>h.includes(b[e]))}},[r,e,s,n,a]),u=S(w=>{if(w){const d=r.filter(p=>!a?.(p)?.disabled).map(p=>p[e]);return o(new Set(d)),{selectedKeys:d,selectedRows:r.filter(p=>d.includes(p[e]))}}else return o(new Set),{selectedKeys:[],selectedRows:[]}},[r,e,a]),x=D(()=>r.length===0?!1:r.filter(d=>!a?.(d)?.disabled).every(d=>n.has(d[e])),[r,n,e,a]),m=D(()=>{if(r.length===0)return!1;const w=r.filter(p=>!a?.(p)?.disabled),d=w.filter(p=>n.has(p[e])).length;return d>0&&d<w.length},[r,n,e,a]),f=S(()=>{o(new Set)},[]);return{selectedKeys:n,isSelected:l,toggleRow:c,toggleAll:u,isAllSelected:x,isIndeterminate:m,clearSelection:f,setSelected:o}}export function useRowExpansion(r="_id",e,s,t=!1){const[a,i]=g(new Set(e||[])),o=s?new Set(s):a,n=S(c=>o.has(c),[o]),l=S(c=>{const u=c[r];return i(m=>{const f=t?new Set:new Set(m);return m.has(u)?f.delete(u):f.add(u),f}),{expandedKeys:o.has(u)?Array.from(o).filter(m=>m!==u):t?[u]:[...Array.from(o),u],expanded:!o.has(u),row:c}},[r,o,t]);return{expandedKeys:o,isExpanded:n,toggleExpand:l,setExpanded:i}}export function useColumnVisibility(r,e){const[s,t]=g(()=>{if(e&&typeof window<"u"){const n=localStorage.getItem(`table_columns_${e}`);if(n)try{return new Set(JSON.parse(n))}catch{}}return new Set(r.filter(n=>n.hidden).map(n=>n.dataField))}),a=D(()=>r.filter(n=>!s.has(n.dataField)),[r,s]),i=S(n=>{t(l=>{const c=new Set(l);return c.has(n)?c.delete(n):c.add(n),e&&typeof window<"u"&&localStorage.setItem(`table_columns_${e}`,JSON.stringify(Array.from(c))),c})},[e]),o=S(()=>{t(new Set),e&&typeof window<"u"&&localStorage.removeItem(`table_columns_${e}`)},[e]);return{hiddenColumns:s,visibleColumns:a,toggleColumn:i,showAllColumns:o,isColumnHidden:n=>s.has(n)}}export function sortData(r,e,s){if(!e.field||!e.order)return r;const t=s.find(i=>i.dataField===e.field);return t?[...r].sort((i,o)=>{const n=getNestedValue(i,e.field),l=getNestedValue(o,e.field);if(t.sortFunc)return t.sortFunc(n,l,e.order,i,o);if(n===l)return 0;if(n==null)return 1;if(l==null)return-1;const c=typeof n=="string"?n.localeCompare(l):n<l?-1:1;return e.order==="asc"?c:-c}):r}export function filterData(r,e,s,t){let a=r;for(const[i,o]of Object.entries(e))o==null||o===""||!s.find(l=>l.dataField===i)||(a=a.filter(l=>{const c=getNestedValue(l,i);return typeof o=="object"&&o!==null?"number"in o&&"comparator"in o?y(c,o.number,o.comparator):"startDate"in o?F(c,o):!0:c==null?!1:String(c).toLowerCase().includes(String(o).toLowerCase())}));if(t){const i=t.toLowerCase();a=a.filter(o=>s.some(n=>{const l=getNestedValue(o,n.dataField);return l==null?!1:String(l).toLowerCase().includes(i)}))}return a}export function paginateData(r,e,s){const t=e*s;return r.slice(t,t+s)}export function getNestedValue(r,e){return e.split(".").reduce((s,t)=>s?.[t],r)}function y(r,e,s){const t=parseFloat(r),a=parseFloat(e);if(isNaN(t)||isNaN(a))return!1;switch(s){case"=":return t===a;case"!=":return t!==a;case">":return t>a;case">=":return t>=a;case"<":return t<a;case"<=":return t<=a;default:return!0}}function F(r,e){if(!r)return!1;const s=new Date(r);if(isNaN(s.getTime()))return!1;if(e.diffFlag&&e.startDate&&e.endDate){const t=new Date(e.startDate),a=new Date(e.endDate);return s>=t&&s<=a}if(e.startDate){const t=new Date(e.startDate);switch(e.comparator){case"=":return s.toDateString()===t.toDateString();case">=":return s>=t;case"<":return s<t;default:return s>=t}}return!0}export function exportToCSV(r,e,s){const t=e.filter(u=>u.csvExport!==!1),a=t.map(u=>`"${u.text}"`).join(","),i=r.map((u,x)=>t.map(m=>{const f=m.csvFormatter?m.csvFormatter(getNestedValue(u,m.dataField),u,x):getNestedValue(u,m.dataField);return f==null?'""':typeof f=="string"?`"${f.replace(/"/g,'""')}"`:typeof f=="object"?`"${JSON.stringify(f).replace(/"/g,'""')}"`:`"${f}"`}).join(",")),o=[a,...i].join(`
`),n=new Blob([o],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(n),c=document.createElement("a");c.href=l,c.download=`${s}_${new Date().toISOString().slice(0,10)}.csv`,c.click(),URL.revokeObjectURL(l)}async function j(){return window.ExcelJS?window.ExcelJS:new Promise((r,e)=>{const s=document.createElement("script");s.src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js",s.async=!0,s.onload=()=>r(window.ExcelJS),s.onerror=()=>e(new Error("Failed to load ExcelJS from CDN")),document.head.appendChild(s)})}export async function exportToExcel(r,e,s,t){try{const a=await j(),i=new a.Workbook,o=i.addWorksheet(t?.sheetName||"Sheet1"),n=e.filter(f=>f.csvExport!==!1);o.columns=n.map(f=>({header:f.text,key:f.dataField,width:Math.max(f.text.length+5,15)}));const l=o.getRow(1);l.font={bold:t?.headerStyle?.font?.bold??!0,size:t?.headerStyle?.font?.size??12},t?.headerStyle?.fill?.color&&(l.fill={type:"pattern",pattern:"solid",fgColor:{argb:t.headerStyle.fill.color.replace("#","")}}),l.commit(),r.forEach((f,w)=>{const d={};n.forEach(p=>{const h=p.csvFormatter?p.csvFormatter(getNestedValue(f,p.dataField),f,w):getNestedValue(f,p.dataField);h==null?d[p.dataField]="":typeof h=="object"?d[p.dataField]=JSON.stringify(h):d[p.dataField]=h}),o.addRow(d)});const c=await i.xlsx.writeBuffer(),u=new Blob([c],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),x=URL.createObjectURL(u),m=document.createElement("a");m.href=x,m.download=`${s}_${new Date().toISOString().slice(0,10)}.xlsx`,m.click(),URL.revokeObjectURL(x)}catch(a){console.error("Excel export failed:",a),console.warn("Falling back to CSV export"),exportToCSV(r,e,s)}}
