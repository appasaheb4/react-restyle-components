"use strict";import{useState as v,useCallback as d,useMemo as S,useEffect as M,useRef as y}from"react";export function useSorting(n=[],t=!1){const[s,e]=v(n),o=d((r,c=!1)=>{e(i=>{const p=i.find(l=>l.colId===r);let f;return p?p.sort==="asc"?f="desc":f=null:f="asc",t&&c?f===null?i.filter(l=>l.colId!==r):p?i.map(l=>l.colId===r?{...l,sort:f}:l):[...i,{colId:r,sort:f}]:f===null?[]:[{colId:r,sort:f}]})},[t]),u=d(r=>{const c=s.findIndex(i=>i.colId===r);return c===-1?{sort:null}:{sort:s[c].sort,sortIndex:t?c:void 0}},[s,t]),h=d(()=>{e([])},[]),a=d((r,c)=>s.length===0?r:[...r].sort((i,p)=>{for(const{colId:f,sort:l}of s){if(!l)continue;const x=c.find(b=>b.field===f||b.colId===f);if(!x||!x.field)continue;const w=x.field,g=getNestedValue(i,w),m=getNestedValue(p,w);if(x.comparator){const b=createRowNode(i,0),I=createRowNode(p,0),E=x.comparator(g,m,b,I,l==="desc");if(E!==0)return l==="asc"?E:-E;continue}let C=0;if(g===m?C=0:g==null?C=1:m==null?C=-1:typeof g=="string"&&typeof m=="string"?C=g.localeCompare(m):C=g<m?-1:1,C!==0)return l==="asc"?C:-C}return 0}),[s]);return{sortModel:s,setSortModel:e,handleSort:o,getSortForColumn:u,clearSort:h,sortData:a}}export function useFiltering(n={}){const[t,s]=v(n),[e,o]=v(""),u=d((i,p)=>{s(f=>{if(p===null){const{[i]:l,...x}=f;return x}return{...f,[i]:p}})},[]),h=d(()=>{s({}),o("")},[]),a=d(i=>i in t,[t]),r=S(()=>Object.keys(t).length>0||e.length>0,[t,e]),c=d((i,p)=>{let f=i;for(const[l,x]of Object.entries(t))f=f.filter(w=>{const g=getNestedValue(w,l);return P(g,x)});if(e){const l=e.toLowerCase();f=f.filter(x=>p.some(w=>{if(!w.field)return!1;const g=getNestedValue(x,w.field);return g==null?!1:String(g).toLowerCase().includes(l)}))}return f},[t,e]);return{filterModel:t,setFilterModel:s,quickFilterText:e,setQuickFilterText:o,setColumnFilter:u,clearFilters:h,isFilterActive:a,hasActiveFilters:r,filterData:c}}function P(n,t){if(n==null)return!1;const s=String(n).toLowerCase();switch(t.filterType){case"text":if(t.filter==null)return!0;const e=String(t.filter).toLowerCase();switch(t.type){case"equals":return s===e;case"notEqual":return s!==e;case"startsWith":return s.startsWith(e);case"endsWith":return s.endsWith(e);case"contains":default:return s.includes(e);case"notContains":return!s.includes(e)}case"number":const o=Number(n),u=Number(t.filter);if(isNaN(o)||isNaN(u))return!1;switch(t.type){case"equals":return o===u;case"notEqual":return o!==u;case"greaterThan":return o>u;case"greaterThanOrEqual":return o>=u;case"lessThan":return o<u;case"lessThanOrEqual":return o<=u;case"inRange":return o>=u&&o<=Number(t.filterTo);default:return!0}case"date":const h=new Date(n);if(isNaN(h.getTime()))return!1;if(t.dateFrom){const a=new Date(t.dateFrom);if(t.dateTo){const r=new Date(t.dateTo);return h>=a&&h<=r}switch(t.type){case"equals":return h.toDateString()===a.toDateString();case"greaterThan":return h>a;case"lessThan":return h<a;default:return h>=a}}return!0;case"set":return!t.values||t.values.length===0?!0:t.values.includes(String(n));default:return!0}}export function usePagination(n,t=10,s=0){const[e,o]=v(s),[u,h]=v(t),a=S(()=>Math.max(1,Math.ceil(n/u)),[n,u]);M(()=>{e>=a&&o(Math.max(0,a-1))},[a,e]);const r=d(m=>{const C=Math.max(0,Math.min(m,a-1));o(C)},[a]),c=d(()=>r(e+1),[e,r]),i=d(()=>r(e-1),[e,r]),p=d(()=>r(0),[r]),f=d(()=>r(a-1),[a,r]),l=d(m=>{h(m),o(0)},[]),x=e*u,w=Math.min(x+u,n),g=d(m=>m.slice(x,x+u),[x,u]);return{currentPage:e,pageSize:u,totalPages:a,totalRows:n,startRow:x,endRow:w,goToPage:r,goToNextPage:c,goToPreviousPage:i,goToFirstPage:p,goToLastPage:f,changePageSize:l,paginateData:g,setCurrentPage:o,setPageSize:h}}export function useRowSelection(n,t,s="multiple",e){const[o,u]=v(new Set),h=d(w=>o.has(w),[o]),a=d((w,g)=>{const m=t(w),C=createRowNode(w,g);e&&!e(C)||u(b=>{if(s==="single")return b.has(m)?new Set:new Set([m]);const I=new Set(b);return I.has(m)?I.delete(m):I.add(m),I})},[t,s,e]),r=d(()=>{const w=n.filter((g,m)=>e?e(createRowNode(g,m)):!0).map(t);u(new Set(w))},[n,t,e]),c=d(()=>{u(new Set)},[]),i=d(w=>{const g=w.map(t);u(new Set(g))},[t]),p=S(()=>n.length===0?!1:n.filter((g,m)=>e?e(createRowNode(g,m)):!0).every(g=>o.has(t(g))),[n,o,t,e]),f=S(()=>{if(n.length===0)return!1;const w=n.filter((m,C)=>e?e(createRowNode(m,C)):!0),g=w.filter(m=>o.has(t(m))).length;return g>0&&g<w.length},[n,o,t,e]),l=S(()=>n.filter(w=>o.has(t(w))),[n,o,t]),x=S(()=>n.map((w,g)=>createRowNode(w,g)).filter(w=>o.has(w.id)),[n,o]);return{selectedIds:o,setSelectedIds:u,isSelected:h,toggleRow:a,selectAll:r,deselectAll:c,selectRows:i,isAllSelected:p,isIndeterminate:f,selectedRows:l,selectedNodes:x}}export function useRowExpansion(n,t=0){const[s,e]=v(new Set),o=d(c=>s.has(c),[s]),u=d(c=>{const i=n(c);e(p=>{const f=new Set(p);return f.has(i)?f.delete(i):f.add(i),f})},[n]),h=d(c=>{const i=c.map(n);e(new Set(i))},[n]),a=d(()=>{e(new Set)},[]),r=d((c,i)=>{e(p=>{const f=new Set(p);return i?f.add(c):f.delete(c),f})},[]);return{expandedIds:s,setExpandedIds:e,isExpanded:o,toggleExpand:u,expandAll:h,collapseAll:a,setExpanded:r}}export function useColumnState(n,t){const[s,e]=v(()=>{if(t&&typeof window<"u"){const l=localStorage.getItem(`ag-grid-columns-${t}`);if(l)try{return JSON.parse(l)}catch{}}return n.map(l=>({colId:l.colId||l.field||"",hide:l.hide??l.initialHide??!1,width:l.width??l.initialWidth,pinned:l.pinned??l.initialPinned??null,sort:l.sort??null}))});M(()=>{t&&typeof window<"u"&&localStorage.setItem(`ag-grid-columns-${t}`,JSON.stringify(s))},[s,t]);const o=d(l=>s.find(x=>x.colId===l),[s]),u=l=>typeof l=="string"?l:l.colId,h=d((l,x)=>{const w=u(l);e(g=>g.map(m=>m.colId===w?{...m,hide:!x}:m))},[]),a=d((l,x)=>{const w=u(l);e(g=>g.map(m=>m.colId===w?{...m,width:x}:m))},[]),r=d((l,x)=>{const w=u(l);e(g=>g.map(m=>m.colId===w?{...m,pinned:x}:m))},[]),c=d((l,x)=>{const w=u(l);e(g=>{const m=g.findIndex(I=>I.colId===w);if(m===-1||m===x)return g;const C=[...g],[b]=C.splice(m,1);return C.splice(x,0,b),C})},[]),i=d(()=>{e(n.map(l=>({colId:l.colId||l.field||"",hide:l.hide??l.initialHide??!1,width:l.width??l.initialWidth,pinned:l.pinned??l.initialPinned??null,sort:l.sort??null})))},[n]),p=S(()=>s.map(l=>{const x=n.find(w=>(w.colId||w.field)===l.colId);return x?{...x,hide:l.hide,width:l.width,pinned:l.pinned,sort:l.sort}:null}).filter(Boolean),[n,s]),f=S(()=>p.filter(l=>!l.hide),[p]);return{columnState:s,setColumnState:e,getColumnState:o,setColumnVisible:h,setColumnWidth:a,setColumnPinned:r,moveColumn:c,resetColumnState:i,processedColumns:p,visibleColumns:f}}export function useCellEditing(n){const[t,s]=v(null),e=y([]),o=y(-1),u=d((f,l,x,w)=>{s({rowId:f,colId:l,rowIndex:x,value:w})},[]),h=d((f=!1,l)=>{t&&(!f&&l!==void 0&&l!==t.value&&(e.current=e.current.slice(0,o.current+1),e.current.push({data:{},field:t.colId,oldValue:t.value,newValue:l}),o.current=e.current.length-1),s(null))},[t]),a=d((f,l)=>t?.rowId===f&&t?.colId===l,[t]),r=d(()=>{if(o.current<0)return null;const f=e.current[o.current];return o.current--,f},[]),c=d(()=>o.current>=e.current.length-1?null:(o.current++,e.current[o.current]),[]),i=o.current>=0,p=o.current<e.current.length-1;return{editingCell:t,startEditing:u,stopEditing:h,isEditing:a,undo:r,redo:c,canUndo:i,canRedo:p}}export function useRowGrouping(n,t,s){const[e,o]=v(new Set),u=d((p,f,l=0)=>{if(f.length===0||p.length===0)return p;const[x,...w]=f,g=new Map;return p.forEach(m=>{const C=getNestedValue(m,x),b=g.get(C)||[];b.push(m),g.set(C,b)}),Array.from(g.entries()).map(([m,C])=>{const b=`${x}:${m}:${l}`,I=u(C,w,l+1),E={};if(s)for(const[N,T]of Object.entries(s)){const D=C.map(k=>getNestedValue(k,N));E[N]=T(D)}return{isGroup:!0,groupValue:m,groupField:x,children:I,level:l,expanded:e.has(b),aggregations:E}})},[e,s]),h=S(()=>u(n,t),[n,t,u]),a=d((p,f,l)=>{const x=`${p}:${f}:${l}`;o(w=>{const g=new Set(w);return g.has(x)?g.delete(x):g.add(x),g})},[]),r=d(()=>{const p=f=>{const l=[];return f.forEach(x=>{"isGroup"in x&&x.isGroup&&(l.push(`${x.groupField}:${x.groupValue}:${x.level}`),l.push(...p(x.children)))}),l};o(new Set(p(h)))},[h]),c=d(()=>{o(new Set)},[]),i=S(()=>{const p=f=>{const l=[];return f.forEach(x=>{l.push(x),"isGroup"in x&&x.isGroup&&x.expanded&&l.push(...p(x.children))}),l};return p(h)},[h]);return{groupedData:h,flattenedData:i,expandedGroups:e,toggleGroup:a,expandAllGroups:r,collapseAllGroups:c}}export function useVirtualScrolling(n,t,s,e=5){const[o,u]=v(0),h=n.length*t,a=S(()=>{const p=Math.max(0,Math.floor(o/t)-e),f=Math.min(n.length,Math.ceil((o+s)/t)+e);return{startIndex:p,endIndex:f}},[o,t,s,n.length,e]),r=S(()=>n.slice(a.startIndex,a.endIndex),[n,a]),c=a.startIndex*t,i=d(p=>{u(p.currentTarget.scrollTop)},[]);return{totalHeight:h,visibleData:r,visibleRange:a,offsetY:c,handleScroll:i,scrollTop:o}}export function useClipboard(){const n=d(async(s,e,o=!0)=>{const u=[];if(o){const a=e.filter(r=>!r.hide).map(r=>r.headerName||r.field||"").join("	");u.push(a)}s.forEach(a=>{const r=e.filter(c=>!c.hide).map(c=>{if(!c.field)return"";const i=getNestedValue(a,c.field);return i==null?"":String(i)}).join("	");u.push(r)});const h=u.join(`
`);await navigator.clipboard.writeText(h)},[]),t=d(async()=>(await navigator.clipboard.readText()).split(`
`).map(e=>e.split("	")),[]);return{copyToClipboard:n,pasteFromClipboard:t}}export function useResponsive(n=768){const[t,s]=v(!1);return M(()=>{const e=()=>{s(window.innerWidth<n)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[n]),{isMobile:t}}export function useContextMenu(){const[n,t]=v({visible:!1,x:0,y:0}),s=d((o,u,h)=>{t({visible:!0,x:o,y:u,data:h})},[]),e=d(()=>{t(o=>({...o,visible:!1}))},[]);return M(()=>{if(!n.visible)return;const o=()=>e(),u=h=>{h.key==="Escape"&&e()};return document.addEventListener("click",o),document.addEventListener("keydown",u),()=>{document.removeEventListener("click",o),document.removeEventListener("keydown",u)}},[n.visible,e]),{contextMenu:n,showContextMenu:s,hideContextMenu:e}}export function useKeyboardNavigation(n,t,s,e){const[o,u]=v(null),h=d(a=>{if(!o)return;const{rowIndex:r,colIndex:c}=o,i=t.filter(p=>!p.hide);switch(a.key){case"ArrowUp":a.preventDefault(),r>0&&u({rowIndex:r-1,colIndex:c});break;case"ArrowDown":a.preventDefault(),r<n.length-1&&u({rowIndex:r+1,colIndex:c});break;case"ArrowLeft":a.preventDefault(),c>0&&u({rowIndex:r,colIndex:c-1});break;case"ArrowRight":a.preventDefault(),c<i.length-1&&u({rowIndex:r,colIndex:c+1});break;case"Enter":a.preventDefault();const p=i[c];p?.field&&e?.(r,p.field);break;case"Tab":a.shiftKey?c>0?(a.preventDefault(),u({rowIndex:r,colIndex:c-1})):r>0&&(a.preventDefault(),u({rowIndex:r-1,colIndex:i.length-1})):c<i.length-1?(a.preventDefault(),u({rowIndex:r,colIndex:c+1})):r<n.length-1&&(a.preventDefault(),u({rowIndex:r+1,colIndex:0}));break}},[o,n.length,t,e]);return M(()=>{if(o){const r=t.filter(c=>!c.hide)[o.colIndex];r?.field&&s?.(o.rowIndex,r.field)}},[o,t,s]),{focusedCell:o,setFocusedCell:u,handleKeyDown:h}}export function getNestedValue(n,t){return t.split(".").reduce((s,e)=>s?.[e],n)}export function setNestedValue(n,t,s){const e=t.split("."),o={...n};let u=o;for(let h=0;h<e.length-1;h++)u[e[h]]={...u[e[h]]},u=u[e[h]];return u[e[e.length-1]]=s,o}export function createRowNode(n,t,s){const e=s||String(t);return{id:e,data:n,rowIndex:t,isSelected:!1,expanded:!1,level:0,setData:()=>{},setSelected:()=>{},isSelectable:()=>!0,setExpanded:()=>{},getRowId:()=>e}}export const aggregations={sum:n=>n.reduce((t,s)=>(t||0)+(s||0),0),avg:n=>{const t=n.filter(s=>s!=null&&!isNaN(s));return t.length?t.reduce((s,e)=>s+e,0)/t.length:0},min:n=>Math.min(...n.filter(t=>t!=null&&!isNaN(t))),max:n=>Math.max(...n.filter(t=>t!=null&&!isNaN(t))),count:n=>n.length,first:n=>n[0],last:n=>n[n.length-1]};export function exportToCsv(n,t,s="export.csv"){const e=t.filter(i=>!i.suppressCsvExport&&!i.hide),o=e.map(i=>`"${i.headerName||i.field||""}"`).join(","),u=n.map(i=>e.map(p=>{if(!p.field)return'""';const f=getNestedValue(i,p.field);return f==null?'""':`"${String(f).replace(/"/g,'""')}"`}).join(",")),h=[o,...u].join(`
`),a=new Blob([h],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(a),c=document.createElement("a");c.href=r,c.download=s,c.click(),URL.revokeObjectURL(r)}export function useSetFilter(n,t){const[s,e]=v(new Set),[o,u]=v(!0),[h,a]=v(""),r=S(()=>{const g=new Set;return n.forEach(m=>{const C=getNestedValue(m,t);C!=null&&g.add(String(C))}),Array.from(g).sort()},[n,t]),c=S(()=>{if(!h)return r;const g=h.toLowerCase();return r.filter(m=>m.toLowerCase().includes(g))},[r,h]);M(()=>{o&&e(new Set(r))},[r,o]);const i=d(g=>{e(m=>{const C=new Set(m);return C.has(g)?C.delete(g):C.add(g),C}),u(!1)},[]),p=d(()=>{o?(e(new Set),u(!1)):(e(new Set(r)),u(!0))},[o,r]),f=d(()=>{e(new Set),u(!1)},[]),l=d(g=>s.has(g),[s]),x=d(g=>{if(o)return!0;const m=getNestedValue(g,t);return m==null?s.size===0:s.has(String(m))},[t,s,o]),w=S(()=>s.size>0&&s.size<r.length,[s,r]);return{uniqueValues:r,filteredValues:c,selectedValues:s,selectAll:o,isIndeterminate:w,searchText:h,setSearchText:a,toggleValue:i,toggleSelectAll:p,selectNone:f,isValueSelected:l,filterFunction:x}}export function useAggregationPanel(n){const[t,s]=v([]),e=d((a,r,c)=>{s(i=>i.some(p=>p.field===a&&p.aggFunc===r)?i:[...i,{field:a,aggFunc:r,displayName:c}])},[]),o=d((a,r)=>{s(c=>c.filter(i=>!(i.field===a&&i.aggFunc===r)))},[]),u=d(()=>{s([])},[]),h=S(()=>{const a={};return t.forEach(({field:r,aggFunc:c})=>{const i=n.map(f=>getNestedValue(f,r)).filter(f=>f!=null&&!isNaN(Number(f))).map(Number),p=`${c}(${r})`;switch(c){case"sum":a[p]=aggregations.sum(i);break;case"avg":a[p]=aggregations.avg(i);break;case"min":a[p]=aggregations.min(i);break;case"max":a[p]=aggregations.max(i);break;case"count":a[p]=aggregations.count(i);break}}),a},[n,t]);return{valueColumns:t,addValueColumn:e,removeValueColumn:o,clearValueColumns:u,aggregatedValues:h}}export function useRowGroupingPanel(n){const[t,s]=v([]),e=d(c=>{s(i=>i.includes(c)?i:[...i,c])},[]),o=d(c=>{s(i=>i.filter(p=>p!==c))},[]),u=d((c,i)=>{s(p=>{const f=[...p],[l]=f.splice(c,1);return f.splice(i,0,l),f})},[]),h=d(()=>{s([])},[]),a=S(()=>n.filter(c=>c.field&&c.enableRowGroup!==!1),[n]),r=S(()=>t.map(c=>{const i=n.find(p=>p.field===c);return{field:c,headerName:i?.headerName||c}}),[t,n]);return{rowGroupColumns:t,addRowGroupColumn:e,removeRowGroupColumn:o,moveRowGroupColumn:u,clearRowGroupColumns:h,groupableColumns:a,groupedColumnsInfo:r}}export function useColumnMenu(){const[n,t]=v({visible:!1,colId:null,x:0,y:0}),[s,e]=v({visible:!1,colId:null,x:0,y:0}),o=d((r,c,i)=>{t({visible:!0,colId:r,x:c,y:i})},[]),u=d(()=>{t(r=>({...r,visible:!1}))},[]),h=d((r,c,i)=>{e({visible:!0,colId:r,x:c,y:i})},[]),a=d(()=>{e(r=>({...r,visible:!1}))},[]);return{menuState:n,showColumnMenu:o,hideColumnMenu:u,filterDropdownState:s,showFilterDropdown:h,hideFilterDropdown:a}}export function useSidePanel(n=!0,t="columns"){const[s,e]=v(n),[o,u]=v(t),h=d(()=>{e(i=>!i)},[]),a=d(()=>{e(!0)},[]),r=d(()=>{e(!1)},[]),c=d(i=>{u(i),s||e(!0)},[s]);return{isOpen:s,activeTab:o,toggle:h,open:a,close:r,switchTab:c,setIsOpen:e,setActiveTab:u}}export function usePivotMode(){const[n,t]=v(!1),[s,e]=v([]),o=d(()=>{t(a=>!a)},[]),u=d(a=>{e(r=>r.includes(a)?r:[...r,a])},[]),h=d(a=>{e(r=>r.filter(c=>c!==a))},[]);return{isPivotMode:n,setIsPivotMode:t,togglePivotMode:o,pivotColumns:s,addPivotColumn:u,removePivotColumn:h}}
